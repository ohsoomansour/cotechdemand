<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ConnectionLogSQL">

	<sql id="search">
		<if test="startdate !=''">		
			<![CDATA[	
				AND TO_CHAR(TO_DATE(CONDTM,'yyyymmddHH24MISS'),'YYYYMMDD') >= #{strdate} 
			]]>
		</if>
		<if test="enddate !=''">
			<![CDATA[
				AND TO_CHAR(TO_DATE(CONDTM,'yyyymmddHH24MISS'),'YYYYMMDD') <= #{enddate}
			]]>
		</if>
		<if test="connectionstate !=''">
			AND CONN_SCD = #{connectionstate}
		</if>
		<if test="userid !=''">
			AND USERID LIKE '%' || #{userid} || '%'
		</if>
	</sql>
	
	<select id="ConnectionLogSQL.doListConnectionLog" resultType="dataMap">
		<!-- 2020.03.27 박인정 -->
		/* 
			SQL ID : ConnectionLogSQL.doListConnectionLog
			이용 로그 조회
		*/
		<![CDATA[
			SELECT
			*
			FROM
			(
			SELECT 
				ROW_NUMBER() OVER(ORDER BY CONDTM DESC) RNUM,
				CONNLOG_SEQ,
				USERID,
				TO_CHAR(TO_DATE(CONDTM, 'yyyymmddHH24MISS'),'YYYY/MM/DD HH24:MI') AS CONDTM,
				CONN_IP,
				(SELECT CDNM FROM TA_COMM_CODE WHERE COMMCD_GCD = 'CONN_PCD' AND CONN_PCD = COMMCD) AS CONN_PCD,
				(SELECT CDNM FROM TA_COMM_CODE WHERE COMMCD_GCD = 'CONN_TCD' AND CONN_TCD = COMMCD) AS CONN_TCD,
				(SELECT CDNM FROM TA_COMM_CODE WHERE COMMCD_GCD = 'CONN_SCD' AND CONN_SCD = COMMCD) AS CONN_SCD,
				NOTE
			FROM 
				TA_CONN_LOG 
			WHERE 
				SITEID = #{siteid}
		 ]]>
			<include refid="search"/>
		<![CDATA[	
			)
			AS
				LOGLIST
			WHERE	
				RNUM BETWEEN (#{page}::INT -1) * (#{rows}::INT) + 1 AND #{page}::INT * #{rows}::INT   		
		]]>
	</select>
	
	<select id="ConnectionLogSQL.doCountConnectionLog" resultType="int">
		<!-- 2020.03.27 박인정 -->
		/* 
			SQL ID : ConnectionLogSQL.doCountConnectionLog
			이용 로그 카운트
		*/
		<![CDATA[
			SELECT 
				COUNT(*)
			FROM 
				TA_CONN_LOG
			WHERE 
				SITEID = #{siteid}		 
		]]>
			<include refid="search"/>	
	</select>	
	
		<select id="ConnectionLogSQL.doListConnectionLogCode" resultType="dataMap">
		<!-- 2020.03.27 박인정 -->
		/* 
			SQL ID : ConnectionLogSQL.doListConnectionLogCode
			이용 로그 코드
		*/
		<![CDATA[
			SELECT 
				COMMCD,
				COMMCD_GCD,
				CDNM
			FROM 
				TA_COMM_CODE	
			WHERE 
				COMMCD_GCD='CONN_SCD'		
				AND COMMCD_LVL = 2
		]]>
	</select>	
</mapper>		