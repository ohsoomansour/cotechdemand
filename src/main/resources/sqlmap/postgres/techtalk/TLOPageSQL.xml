<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="TLOPageSQL">
	 <select id="TLOPageSQL.doCountCorporates" resultType="int">
		<!--  
			2023.10.06 수정중... 
			SQL ID : TLOPageSQL.doCountCorporates
			기업 카운트: 
			
			member_type == 'ADMIN' 의 경우
			select COUNT(*) 
				from techdemand_corporate tc
			WHERE tc.view_yn = 'Y'
			
			select COUNT(*) 
					from techdemand_corporate tc
					left outer join tblmember t on tc.tlo_seqno = t.member_seqno::varchar
					left outer join tblbusiness b on t.biz_name = b.biz_name
					where tc.view_yn = 'Y'	
		-->
			<if test="member_type == 'TLO'" >
				<![CDATA[
					select COUNT(*) 
					from techdemand_corporate tc
					where tc.compa_name = #{biz_name}
					AND tc.view_yn = 'Y'
				]]>	
			</if>
			<if test="member_type == 'ADMIN'" >
			
			<![CDATA[
				select COUNT(*) 
					from techdemand_corporate tc
				WHERE tc.view_yn = 'Y' 
				]]>
				
				<!--
				<![CDATA[
					SELECT COUNT(*)
					FROM (
						SELECT TD.CO_TD_NO
								, TD.COMPA_NAME
								, TD.keyword
								, (SELECT CODE_NAME FROM tbtech_code tc WHERE tc.CODE_KEY = TD.BIG_CATEGORY) AS CODE_NAME1
								, (SELECT CODE_NAME FROM tbtech_code tc WHERE tc.CODE_KEY = TD.MID_CATEGORY) AS CODE_NAME2
								, (SELECT CODE_NAME FROM tbtech_code tc WHERE tc.CODE_KEY = TD.SMALL_CATEGORY) AS CODE_NAME3
								, TD.view_yn
								
						FROM TECHDEMAND_CORPORATE TD
						where TD.ADMIN_SEQNO = '0' 
				]]>
					
				<if test="list != 'all'" >
					AND TD.view_yn = 'Y'
				</if>
				<if test="keyword != ''" >
					AND TD.keyword like CONCAT('%',#{keyword},'%')
				</if>
				<if test="strDate != ''" >
					<![CDATA[	
						AND '${strDate}' <= TD.UPDATE
					]]>		
				</if>
				<if test="endDate != ''" >
					<![CDATA[	
						AND TD.UPDATE <= '${endDate}'
					]]>		
				</if>
				<if test="filterStdClassCd1 != ''" >
					AND TD.BIG_CATEGORY = '${filterStdClassCd1}'
				</if>
				<if test="filterStdClassCd2 != ''" >
					AND TD.MID_CATEGORY = '${filterStdClassCd2}'
				</if>
				<if test="filterStdClassCd3 != ''" >
					AND TD.SMALL_CATEGORY = '${filterStdClassCd3}'
				</if>
						GROUP BY TD.CO_TD_NO
						ORDER BY TD.UPDATE desc
					) CT	
			  -->	
					
			</if>
	</select>
	<select id="TLOPageSQL.doGetCoTechDemandInfo" parameterType="dataMap" resultType="dataMap">
		<!--  
			SQL ID: TLOPageSQL.doGetCoTechDemandInfo
			TLO가 관리하는 기업에 따른 기업 목록 조회: 예) '고려대학교' TLO의 경우 == Business 멤버 아이디가 멤버타입이 '고려대학교'의 경우 (9.22)  
			*추가 예정:
		-->
		<![CDATA[
			SELECT 
				A.COMPA_NAME
				, CO_TD_NO
				, KEYWORD
				, SPLIT_PART(KEYWORD::VARCHAR, ',', 1) AS KEYWORD1
				, SPLIT_PART(KEYWORD::VARCHAR, ',', 2) AS KEYWORD2
				, SPLIT_PART(KEYWORD::VARCHAR, ',', 3) AS KEYWORD3
				, SPLIT_PART(KEYWORD::VARCHAR, ',', 4) AS KEYWORD4
				, SPLIT_PART(KEYWORD::VARCHAR, ',', 5) AS KEYWORD5
				, BIG_CATEGORY
				, MID_CATEGORY
				, SMALL_CATEGORY
				, (SELECT CODE_NAME FROM tbtech_code AA WHERE AA.CODE_KEY = A.BIG_CATEGORY) AS CODE_NAME1
				, (SELECT CODE_NAME FROM tbtech_code AA WHERE AA.CODE_KEY = A.MID_CATEGORY) AS CODE_NAME2
				, (SELECT CODE_NAME FROM tbtech_code AA WHERE AA.CODE_KEY = A.SMALL_CATEGORY) AS CODE_NAME3
				, CORPORATE_PROBLEM
				, HOLD_RND_INFRA
				, WILLINGNESS_TO_INVEST
				, DEPT
				, MANAGER_POSITION
				, MANAGER_NAME
				, MOBILEPHONE_NUM
				, A.biz_email
				, A.MEMBER_SEQNO
				, TECH_NEEDS
				, view_yn
			
		]]>
		  	<if test="member_type == 'TLO'" >
				<![CDATA[
					FROM TECHDEMAND_CORPORATE AS A
					INNER JOIN (SELECT * FROM TBLMEMBER WHERE id = '${id}') AS B
					ON A.COMPA_NAME = B.BIZ_NAME
				]]>	
			</if>
			<if test="member_type == 'ADMIN'" >
				<![CDATA[
					FROM TECHDEMAND_CORPORATE AS A
					INNER JOIN (SELECT * FROM TBLMEMBER WHERE id = '${id}') AS B
					ON A.ADMIN_SEQNO = B.MEMBER_SEQNO
				]]>	
			</if>	
			
			<if test="list != 'all'" >
				<![CDATA[
					AND A.view_yn = 'Y'
				]]>	
			</if>			
			<if test= "strDate != ''" >
				<![CDATA[
					
				AND A.UPDATE > #{strDate}
					]]>	
			</if>
				
			<if test= "endDate != ''" >
				<![CDATA[
				AND A.UPDATE <= #{endDate}
				]]>	
			</if>
			<if test = "filterStdClassCd1 != '' ">
				<![CDATA[
					AND A.BIG_CATEGORY = #{filterStdClassCd1}
				]]>	     
			</if>
			<if test = "filterStdClassCd2 != '' ">
				<![CDATA[
					 AND A.MID_CATEGORY = #{filterStdClassCd2}
				]]>	    
			</if>
			<if test = "filterStdClassCd3 != '' ">
				<![CDATA[
					AND A.SMALL_CATEGORY = #{filterStdClassCd3}
				]]>	
				</if>
			<if test="keyword != ''" >
				<![CDATA[
					AND A.keyword like CONCAT('%',#{keyword},'%') 
				]]>
			</if>
			<!--  tbiz.tblresearcher; 의 keyword 컬럼과 겹치는 '기술수요 기업'   -->
			<if test="matching == 'Y'">
				<![CDATA[
					INNER JOIN tblresearcher AS R on R.KEYWORD like CONCAT('%',#{keyword},'%') 
				]]>  
			</if>
			
				ORDER BY UPDATE desc
				LIMIT ${rows} OFFSET (${page}-1) * 5;
		   
	</select>
	<select id="TLOPageSQL.doGetCodeListInfo" parameterType="dataMap" resultType="dataMap">
		/*
			2023.09.18 
			기술분류 목록, SQL ID: TLOPageSQL.doGetCodeListInfo
			 
		*/
		<![CDATA[
			SELECT
				*
			FROM
				TBTECH_CODE
			WHERE CODE_DEPTH = #{depth}::INT
			
		]]>
			<if test="parent_code_key != ''">
			AND PARENT_CODE_KEY = #{parent_code_key}
			</if>
			ORDER BY CODE_KEY ASC
	</select>
	
	<select id="TLOPageSQL.doGetManager" parameterType="dataMap" resultType="dataMap">
		/*
			SQL ID: TLOPageSQL.doGetManager
			담당자정보
		*/
		<![CDATA[
			SELECT 
				dept,
				manager_position,
				manager_name,
				mobilephone_num,
				biz_email
			FROM techdemand_corporate
			WHERE corporate_seqno = '${corporate_seqno}'
		]]>
	</select>
	<sql id="condition">
	
		<if test="MID_CATEGORY !=''">		
		
		</if>
		<if test="SMALL_CATEGORY !=''">		
		
		</if>
	
	
	</sql>
	<update id="TLOPageSQL.doUpdateViewYn" parameterType="dataMap">
		/*
			SQL ID : TLOPageSQL.doUpdateViewYn
			마이페이지 tlo 기업 목록관리
		*/
			<![CDATA[
				UPDATE techdemand_corporate
				SET VIEW_YN = #{view_yn},
					UPDATE = CURRENT_DATE 
				WHERE CO_TD_NO = #{co_td_no}::INT
			]]>
	</update>	
	<update id="TLOPageSQL.doUpdateCorporate" parameterType="dataMap" >
			 /* 
				SQL ID : TLOPageSQL.doUpdateCorporate
				2023.09.19 마이페이지 기업 수정중.. 
			*/
				
				<![CDATA[
				UPDATE TECHDEMAND_CORPORATE
					SET 
						COMPA_NAME = #{compa_name},
						MID_CATEGORY = #{mid_category},
						SMALL_CATEGORY = #{small_category}, 
						KEYWORD = #{keyword},
						TECH_NEEDS = #{tech_needs},
						CORPORATE_PROBLEM = #{corporate_problem},
						HOLD_RND_INFRA =  #{hold_rnd_infra},	
						WILLINGNESS_TO_INVEST = #{willingness_to_invest},
						DEPT = #{dept},
						MANAGER_POSITION = #{manager_position},
						MANAGER_NAME = #{manager_name},
						MOBILEPHONE_NUM = #{mobilephone_num},
						BIZ_EMAIL = #{biz_email}
					
				WHERE CO_TD_NO = #{co_td_no}::INT
				
			]]>
			
	</update>

</mapper>