<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="TLOPageSQL">
<!--
	<select id="TLOPageSQL.doGetCoTechDemandInfo" parameterType="dataMap" resultType="dataMap">
		/*
			SQL ID: TLOPageSQL.doGetCoTechDemandInfo
			기업 목록 조회  >> 변경중..
		*/
		<![CDATA[
			SELECT 
				A.COMPA_NAME
				, CO_TD_NO
				, KEYWORD
				, SPLIT_PART(KEYWORD::VARCHAR, ',', 1) AS KEYWORD1
				, SPLIT_PART(KEYWORD::VARCHAR, ',', 2) AS KEYWORD2
				, SPLIT_PART(KEYWORD::VARCHAR, ',', 3) AS KEYWORD3
				, SPLIT_PART(KEYWORD::VARCHAR, ',', 4) AS KEYWORD4
				, SPLIT_PART(KEYWORD::VARCHAR, ',', 5) AS KEYWORD5
				, MID_CATEGORY
				, SMALL_CATEGORY
				, (SELECT CODE_NAME FROM tbtech_code AA WHERE AA.CODE_KEY = A.MID_CATEGORY) AS CODE_NAME2
				, (SELECT CODE_NAME FROM tbtech_code AA WHERE AA.CODE_KEY = A.SMALL_CATEGORY) AS CODE_NAME3
				, CORPORATE_PROBLEM
				, HOLD_RND_INFRA
				, WILLINGNESS_TO_INVEST
				, DEPT
				, MANAGER_POSITION
				, MANAGER_NAME
				, MOBILEPHONE_NUM
				, A.biz_email
				, A.MEMBER_SEQNO
				, TECH_NEEDS
			FROM TECHDEMAND_CORPORATE AS A
			INNER JOIN (SELECT * FROM TBLMEMBER WHERE id = '${id}') AS B
			ON A.MEMBER_SEQNO::INT = B.MEMBER_SEQNO
		]]>
	</select>
	 -->
	 <select id="TLOPageSQL.doCountCorporates" resultType="int">
		/*
			2023.09.24 수정중... 
			SQL ID : TLOPageSQL.doCountCorporates
			기업 카운트
		*/
		<![CDATA[
			select COUNT(*) 
			from techdemand_corporate tc
			left outer join tblmember t on tc.tlo_seqno::INT = t.member_seqno
			left outer join tblbusiness b on t.biz_name = b.biz_name
			where b.biz_name = #{biz_name} AND tc.view_yn = 'Y'
		]]>
	</select>
	<select id="TLOPageSQL.doGetCoTechDemandInfo" parameterType="dataMap" resultType="dataMap">
		/*
			SQL ID: TLOPageSQL.doGetCoTechDemandInfo
			TLO가 관리하는 기업에 따른 기업 목록 조회: 예) '고려대학교' TLO의 경우 == Business 멤버 아이디가 멤버타입이 '고려대학교'의 경우 (9.22)  
		*/
		<![CDATA[
			SELECT 
				A.COMPA_NAME
				, CO_TD_NO
				, KEYWORD
				, SPLIT_PART(KEYWORD::VARCHAR, ',', 1) AS KEYWORD1
				, SPLIT_PART(KEYWORD::VARCHAR, ',', 2) AS KEYWORD2
				, SPLIT_PART(KEYWORD::VARCHAR, ',', 3) AS KEYWORD3
				, SPLIT_PART(KEYWORD::VARCHAR, ',', 4) AS KEYWORD4
				, SPLIT_PART(KEYWORD::VARCHAR, ',', 5) AS KEYWORD5
				, MID_CATEGORY
				, SMALL_CATEGORY
				, (SELECT CODE_NAME FROM tbtech_code AA WHERE AA.CODE_KEY = A.MID_CATEGORY) AS CODE_NAME2
				, (SELECT CODE_NAME FROM tbtech_code AA WHERE AA.CODE_KEY = A.SMALL_CATEGORY) AS CODE_NAME3
				, CORPORATE_PROBLEM
				, HOLD_RND_INFRA
				, WILLINGNESS_TO_INVEST
				, DEPT
				, MANAGER_POSITION
				, MANAGER_NAME
				, MOBILEPHONE_NUM
				, A.biz_email
				, A.MEMBER_SEQNO
				, TECH_NEEDS
				, view_yn
			FROM TECHDEMAND_CORPORATE AS A
			INNER JOIN (SELECT * FROM TBLMEMBER WHERE id = '${id}') AS B
			ON A.COMPA_NAME = B.BIZ_NAME
		]]>
		  
			<if test="list != 'all'" >
				AND A.view_yn = 'Y'
			</if>
			<!--  날짜/ 기술분류 값 / 매칭여부에 따라 >> 기술수요 목록을 띄워주면된다   
			<if test= "endDate != '' " >
				A.UPDATE <= #{endDate}
			</if>
			
			<if test = "tech1! != '' ">
			    A.MID_CATEGORY = #{tech2}
			</if>
			<if test = "tech2! != '' ">
			    A.MID_CATEGORY = #{tech2}
			</if>
			<if test = "tech3! != '' ">
			    A.SMALL_CATEGORY = #{tech3}
			</if>
			-->
			
				ORDER BY CO_TD_NO desc
				LIMIT ${rows} OFFSET (${page}-1) * 5;
		
	</select>
	<!-- 업데이트를 해서 when 날짜가 존재할 때 <if test="strDate != ''" >
				
			</if>
	    매칭 여부 Y/N에 따라 select 한다 
	     
			
			
	-->
			
			
			
	<!--
	<select id="TLOPageSQL.doGetTLOCorporateList" parameterType="dataMap" resultType="dataMap">
		/*
			SQL ID: TLOPageSQL.doGetTLOCorporateList
			TLO 기업 목록 - 2023.09.24 수정중..
		*/
		<![CDATA[
			SELECT tc.member_seqno
					,tc.compa
					,tc.biz_name
					, tc.keyword
					, MAX(applicant_date) as applicant_date
					, (SELECT CODE_NAME FROM TBTECH_CODE AS AA WHERE AA.CODE_KEY = tc.TECH_CODE1) AS CODE_NAME1
					, (SELECT CODE_NAME FROM TBTECH_CODE AS AA WHERE AA.CODE_KEY = tc.TECH_CODE2) AS CODE_NAME2
					, (SELECT CODE_NAME FROM TBTECH_CODE AS AA WHERE AA.CODE_KEY = tc.TECH_CODE3) AS CODE_NAME3
					, view_yn
			from techdemand_corporate tc
			left outer join tblmember t on tc.member_seqno = t.member_seqno
			left outer join tblbusiness b on t.biz_name = b.biz_name
			left outer join tblresearch_temp tp ON tc.researcher_seqno = tp.researcher_seqno
			where b.biz_name = '${biz_name}' 
		]]>	
			<if test="list != 'all'" >
				AND tc.view_yn = 'Y'
			</if>
			<if test="keyword != ''" >
			AND tc.keyword like CONCAT('%',#{keyword},'%')
			</if>
			GROUP BY tc.researcher_seqno
			ORDER BY applicant_date desc
			LIMIT ${rows} OFFSET (${page}-1)*5;
	</select>
	 -->
	<select id="TLOPageSQL.doGetCodeListInfo" parameterType="dataMap" resultType="dataMap">
		/*
			2023.09.18 
			SQL ID: TLOPageSQL.doGetCodeListInfo
			 기술분류 목록: depth에 따라 코드를 불러오고
		*/
		<![CDATA[
			SELECT
				*
			FROM
				TBTECH_CODE
			WHERE CODE_DEPTH = #{depth}::INT
			
		]]>
			<if test="parent_code_key != ''">
			AND PARENT_CODE_KEY = #{parent_code_key}
			</if>
			ORDER BY CODE_KEY ASC
	</select>
	
	<select id="TLOPageSQL.doGetManager" parameterType="dataMap" resultType="dataMap">
		/*
			SQL ID: TLOPageSQL.doGetManager
			담당자정보
		*/
		<![CDATA[
			SELECT 
				dept,
				manager_position,
				manager_name,
				mobilephone_num,
				biz_email
			FROM techdemand_corporate
			WHERE corporate_seqno = '${corporate_seqno}'
		]]>
	</select>
	<sql id="condition">
	
		<if test="MID_CATEGORY !=''">		
		
		</if>
		<if test="SMALL_CATEGORY !=''">		
		
		</if>
	
	
	</sql>
	<update id="TLOPageSQL.doUpdateViewYn" parameterType="dataMap">
		/*
			SQL ID : TLOPageSQL.doUpdateViewYn
			마이페이지 tlo 기업 목록관리
		*/
			<![CDATA[
				UPDATE techdemand_corporate
				SET VIEW_YN = #{view_yn},
					UPDATE = CURRENT_DATE 
				WHERE CO_TD_NO = #{co_td_no}::INT
			]]>
	</update>	
	<update id="TLOPageSQL.doUpdateCorporate" parameterType="dataMap" >
			 /* 
				SQL ID : TLOPageSQL.doUpdateCorporate
				2023.09.19 마이페이지 기업 수정중.. 
			*/
				
				<![CDATA[
				UPDATE TECHDEMAND_CORPORATE
					SET 
						COMPA_NAME = #{compa_name},
						MID_CATEGORY = #{mid_category},
						SMALL_CATEGORY = #{small_category}, 
						KEYWORD = #{keyword},
						TECH_NEEDS = #{tech_needs},
						CORPORATE_PROBLEM = #{corporate_problem},
						HOLD_RND_INFRA =  #{hold_rnd_infra},	
						WILLINGNESS_TO_INVEST = #{willingness_to_invest},
						DEPT = #{dept},
						MANAGER_POSITION = #{manager_position},
						MANAGER_NAME = #{manager_name},
						MOBILEPHONE_NUM = #{mobilephone_num},
						BIZ_EMAIL = #{biz_email}
					
				WHERE CO_TD_NO = #{co_td_no}::INT
				
			]]>
			
	</update>

	<!--  
	<select id="TLOPageSQL.doGetSimilar" parameterType="dataMap" resultType="dataMap">
		/*
			SQL ID : TLOPageSQL.doGetSimilar
			유사분야 연구자 리스트
		*/
		<![CDATA[
			SELECT DISTINCT RESEARCH_NO, RESEARCH_NM, KEYWORD, TECH_NM1, TECH_NM2, TECH_NM3, APPLICANT_NM, APPLICANT_DATE
			
			FROM TBRESEARCH 
		]]>
		<if test="researcher_seqno != ''">
			WHERE NOT RESEARCH_SEQNO IN (#{researcher_seqno}::INT)
		</if>
		<choose>
			<when test="keyword_split1 != ''">
				<if test="keyword_split1 != ''">
					AND KEYWORD LIKE '%' || #{keyword_split1} || '%'
				</if>
				<if test="keyword_split2 != ''">
					AND KEYWORD LIKE '%' || #{keyword_split2} || '%'
				</if>
				<if test="keyword_split3 != ''">
					AND KEYWORD LIKE '%' || #{keyword_split3} || '%'
				</if>
			</when>
			<otherwise>
				AND KEYWORD = #{keyword}
			</otherwise>
		</choose>
		
 		 ORDER BY APPLICANT_DATE DESC
 		 LIMIT 3;
	</select>
	
	<select id="TLOPageSQL.doGetProject" parameterType="dataMap" resultType="dataMap">
		/*
			SQL ID : TLOPageSQL.doGetProject
			마이페이지 국가 과제 수행이력
		*/
		
		SELECT DISTINCT ON(ASSIGNM_NO)
			ASSIGNM_NO, RE_PROJECT_NM, RE_INSTITU_NM, RE_START_DATE, RE_END_DATE
		FROM(	
		SELECT ASSIGNM_NO, RE_PROJECT_NM, RE_INSTITU_NM, RE_START_DATE, RE_END_DATE
		FROM TBLRESEARCH_HISTORY
		WHERE RESEARCHER_SEQNO = '${researcher_seqno}'
		UNION ALL
		SELECT ASSIGNM_NO,RE_PROJECT_NM, RE_INSTITU_NM, RE_START_DATE, RE_END_DATE
		FROM TBLRESEARCH_TEMP
		WHERE RESEARCHER_SEQNO = '${researcher_seqno}'
		) A
		ORDER BY ASSIGNM_NO DESC
	</select>
	
	<select id="TLOPageSQL.doGetHistory" parameterType="dataMap" resultType="dataMap">
		/*
			SQL ID : TLOPageSQL.doGetHistory
			연구히스토리 리스트
		*/
		SELECT DISTINCT ON(HIS_DATE)
				SUBSTRING(RE_START_DATE, 0, 5) AS HIS_DATE,
				RE_START_DATE,
				KEYWORD
		FROM (			
			SELECT RE_START_DATE, KEYWORD
			FROM TBLRESEARCH_TEMP WHERE RESEARCHER_SEQNO = '${researcher_seqno}'
			UNION ALL
			SELECT RE_START_DATE, KEYWORD
			FROM TBLRESEARCH_HISTORY WHERE RESEARCHER_SEQNO = '${researcher_seqno}'
		) A
		ORDER BY HIS_DATE DESC 
		LIMIT 5
	</select>
	
	<select id="TLOPageSQL.doGetInvent" parameterType="dataMap" resultType="dataMap">
		/*
			SQL ID : TLOPageSQL.doGetInvent
			마이페이지 특허 리스트
		*/
		<![CDATA[
			SELECT RESEARCH_SEQNO, INVENT_NM, APPLICATION_NO, APPLICANT_DATE
			
			FROM TBLRESEARCH_TEMP
		]]>
		<if test="researcher_seqno != ''">
			WHERE RESEARCHER_SEQNO = '${researcher_seqno}'
		</if>
		ORDER BY RESEARCH_SEQNO DESC
	</select>
	
	<update id="TLOPageSQL.doUpdateResearcher" parameterType="dataMap">
		/*
			SQL ID : TLOPageSQL.doUpdateResearcher
			2023.09.19  
		*/
		UPDATE TBLRESEARCHER
		SET TECH_CODE1 = '${selStdClassCd1}',
			TECH_CODE2 = '${selStdClassCd2}',
			TECH_CODE3 = '${selStdClassCd3}',
			KEYWORD = '${keyword1}${keyword2}${keyword3}${keyword4}${keyword5}',
			RE_INTRO_FIELD = '${re_intro_field}'
		WHERE RESEARCHER_SEQNO= '${researcher_seqno}'
	</update>
	-->
	
	
	
</mapper>