<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="MyPageSQL">

	<select id="MyPageSQL.doGetResearcherInfo" parameterType="dataMap" resultType="dataMap">
		/*
			SQL ID: MyPageSQL.doGetResearcherInfo
			연구자 목록 조회
		*/
		<![CDATA[
		SELECT 
			USER_NAME
			, BIZ_NAME
			, RE_INTRO_FIELD
			, KEYWORD
			, SPLIT_PART(KEYWORD::VARCHAR, ',', 1) AS KEYWORD1
			, SPLIT_PART(KEYWORD::VARCHAR, ',', 2) AS KEYWORD2
			, SPLIT_PART(KEYWORD::VARCHAR, ',', 3) AS KEYWORD3
			, SPLIT_PART(KEYWORD::VARCHAR, ',', 4) AS KEYWORD4
			, SPLIT_PART(KEYWORD::VARCHAR, ',', 5) AS KEYWORD5
			, TECH_CODE1
			, (SELECT CODE_NAME FROM TBTECH_CODE AS AA WHERE AA.CODE_KEY = TECH_CODE1) AS CODE_NAME1
			, TECH_CODE2
			, (SELECT CODE_NAME FROM TBTECH_CODE AS AA WHERE AA.CODE_KEY = TECH_CODE2) AS CODE_NAME2
			, TECH_CODE3
			, (SELECT CODE_NAME FROM TBTECH_CODE AS AA WHERE AA.CODE_KEY = TECH_CODE3) AS CODE_NAME3
			, RESEARCHER_SEQNO
		FROM TBLRESEARCHER AS A
		INNER JOIN (SELECT * FROM TBLMEMBER WHERE id = '${id}') AS B
		ON A.MEMBER_SEQNO = B.MEMBER_SEQNO
		]]>
	</select>
	
	<select id="MyPageSQL.doGetCodeListInfo" parameterType="dataMap" resultType="dataMap">
		/*
			SQL ID: MyPageSQL.doGetCodeListInfo
			연구자 기술분류 목록
		*/
		<![CDATA[
			SELECT
				*
			FROM
				TBTECH_CODE
			WHERE CODE_DEPTH = #{depth}::INT
			
		]]>
			<if test="parent_code_key != ''">
			AND PARENT_CODE_KEY = #{parent_code_key}
			</if>
			ORDER BY CODE_KEY ASC
	</select>
	
	<select id="MyPageSQL.doGetManager" parameterType="dataMap" resultType="dataMap">
		/*
			SQL ID: MyPageSQL.doGetManager
			담당자정보
		*/
		<![CDATA[
		SELECT * FROM TBLMANAGER
		WHERE RESEARCHER_SEQNO = '${researcher_seqno}'
		]]>
	</select>

	<select id="MyPageSQL.doGetSimilar" parameterType="dataMap" resultType="dataMap">
		/*
			SQL ID : SubjectFrontSQL.doSimilarResearchList
			유사분야 연구자 리스트
		*/
		<![CDATA[
			SELECT DISTINCT RESEARCH_NO, RESEARCH_NM, KEYWORD, TECH_NM1, TECH_NM2, TECH_NM3, APPLICANT_NM, APPLICANT_DATE
			
			FROM TBRESEARCH 
		]]>
		<if test="researcher_seqno != ''">
			WHERE NOT RESEARCH_SEQNO IN (#{researcher_seqno}::INT)
		</if>
		<choose>
			<when test="keyword_split1 != ''">
				<if test="keyword_split1 != ''">
					AND KEYWORD LIKE '%' || #{keyword_split1} || '%'
				</if>
				<if test="keyword_split2 != ''">
					AND KEYWORD LIKE '%' || #{keyword_split2} || '%'
				</if>
				<if test="keyword_split3 != ''">
					AND KEYWORD LIKE '%' || #{keyword_split3} || '%'
				</if>
			</when>
			<otherwise>
				AND KEYWORD = #{keyword}
			</otherwise>
		</choose>
		
 		 ORDER BY APPLICANT_DATE DESC
 		 LIMIT 3;
	</select>
	
	<select id="MyPageSQL.doGetProject" parameterType="dataMap" resultType="dataMap">
		/*
			SQL ID : MyPageSQL.doGetProject
			마이페이지 국가 과제 수행이력
		*/
		<![CDATA[
			SELECT RE_PROJECT_NM, RE_INSTITU_NM, RE_START_DATE, RE_END_DATE
			
			FROM TBLRESEARCH_TEMP
		]]>
		<if test="researcher_seqno != ''">
			WHERE RESEARCHER_SEQNO = '${researcher_seqno}'
		</if>
		ORDER BY RE_START_DATE DESC
	</select>
	
	<select id="MyPageSQL.doGetHistory" parameterType="dataMap" resultType="dataMap">
		/*
			SQL ID : MyPageSQL.doGetHistory
			연구히스토리 리스트
		*/
		SELECT DISTINCT ON(HIS_DATE)
			SUBSTRING(RE_START_DATE, 0, 5) AS HIS_DATE,
			RE_START_DATE,
			KEYWORD
		FROM TBLRESEARCH_HISTORY WHERE RESEARCHER_SEQNO = '${researcher_seqno}'
		ORDER BY HIS_DATE DESC
		LIMIT 5
	</select>
	
	<select id="MyPageSQL.doGetInvent" parameterType="dataMap" resultType="dataMap">
		/*
			SQL ID : MyPageSQL.doGetInvent
			마이페이지 특허 리스트
		*/
		<![CDATA[
			SELECT RESEARCH_SEQNO, INVENT_NM, APPLICATION_NO, APPLICANT_DATE
			
			FROM TBLRESEARCH_TEMP
		]]>
		<if test="researcher_seqno != ''">
			WHERE RESEARCHER_SEQNO = '${researcher_seqno}'
		</if>
		ORDER BY RESEARCH_SEQNO DESC
	</select>
	
	<update id="MyPageSQL.doUpdateResearcher" parameterType="dataMap">
		/*
			SQL ID : MyPageSQL.doUpdateResearcher
			마이페이지 연구자 수정
		*/
		UPDATE TBLRESEARCHER
		SET TECH_CODE1 = '${selStdClassCd1}',
			TECH_CODE2 = '${selStdClassCd2}',
			TECH_CODE3 = '${selStdClassCd3}',
			KEYWORD = '${keyword1}${keyword2}${keyword3}${keyword4}${keyword5}',
			RE_INTRO_FIELD = '${re_intro_field}'
		WHERE RESEARCHER_SEQNO= '${researcher_seqno}'
	</update>
	
	<update id="MyPageSQL.doUpdateInvent" parameterType="dataMap">
		/*
			SQL ID : MyPageSQL.doUpdateInvent
			마이페이지 연구자 특허 수정
		*/
		UPDATE TBLRESEARCH_TEMP
		SET INVENT_NM = '${invent_nm}',
			 APPLICATION_NO = '${applicant_no}',
			 APPLICANT_DATE = '${applicant_dt}'
		WHERE RESEARCH_SEQNO= '${research_seqno}'
	</update>
	
	<update id="MyPageSQL.doUpdateManager" parameterType="dataMap">
		/*
			SQL ID : MyPageSQL.doUpdateManager
			마이페이지 연구자 담당자 수정
		*/
		UPDATE TBLMANAGER
		SET MANAGER_DEMAND = '${manager_demand}',
			MANAGER_RANK = '${manager_rank}',
			MANAGER_NAME = '${manager_name}',
			MANAGER_MOBILE_NO = '${tel}',
			MANAGER_EMAIL = '${mail}'
		WHERE RESEARCHER_SEQNO= '${researcher_seqno}'	
	</update>
</mapper>