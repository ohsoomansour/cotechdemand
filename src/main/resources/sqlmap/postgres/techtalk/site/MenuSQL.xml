<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="MenuSQL">
	<!-- ====================================================================================== -->
	<!--									메뉴코드 조회											-->
	<!-- ====================================================================================== -->
	<select id="MenuSQL.doListMenuPCD" resultType="dataMap">
		<!-- 2020-05-08 추정완 -->
		/*
			SQL ID : MenuSQL.doListMenuPCD
			메뉴 구분 조회
		*/
		<![CDATA[
			SELECT
				*
			FROM
				TA_COMM_CODE
			WHERE
				SITEID = #{siteid}
			AND COMMCD_GCD = 'MENU_PCD'
			AND COMMCD_LVL = 2
		]]>
	</select>
	
	<select id="MenuSQL.doListMenuTree" resultType="dataMap">
		<!-- 2020-05-07 추정완 -->
		/*
			SQL ID : MenuSQL.doListMenuTree
			메뉴리스트 조회
		*/
		<![CDATA[
			WITH RECURSIVE MENU_LIST
				(
					MENUCD,
					UP_CD,
			]]>
			<choose>
				<when test="locale == 'en_US'">
					MENUNM_EN AS MENUNM,
				</when>
				<otherwise>
					MENUNM,
				</otherwise>
			</choose>
			<![CDATA[
					MENU_IDX, 
					MENU_LVL,
					MENU_PCD, 
					MENU_TCD, 
					MENU_OPT, 
					MENU_URL, 
					PATH,
					CYCLE
				)
			AS
				(
					SELECT
						M.MENUCD, 
						M.UP_CD,
						M.MENUNM,
						M.MENU_IDX,
						M.MENU_LVL,
						M.MENU_PCD,
						M.MENU_TCD,
						M.MENU_OPT,
						M.MENU_URL,
						ARRAY[M.MENUCD::text],
						FALSE
					FROM
						TA_MENU M
					WHERE
						M.MENU_LVL = 1 AND M.USEYN = 'Y' AND M.MENU_TCD = #{menu_tcd}
					UNION ALL
					SELECT
						M.MENUCD, 
						M.UP_CD,
						M.MENUNM,
						M.MENU_IDX,
						M.MENU_LVL,
						M.MENU_PCD,
						M.MENU_TCD,
						M.MENU_OPT,
						M.MENU_URL,
						ARRAY_APPEND(ML.PATH, M.MENUCD::text), 
						M.MENUCD = ANY(ML.PATH)
					FROM
						TA_MENU M, MENU_LIST ML
					WHERE M.UP_CD = ML.MENUCD AND NOT CYCLE 
				)
			SELECT 
				ML.MENUCD, 
				ML.UP_CD,
				ML.MENUNM,
				ML.MENU_IDX,
				ML.MENU_LVL,
				ML.MENU_PCD,
				ML.MENU_TCD,
				ML.MENU_OPT,
				ML.MENU_URL
			FROM 
				MENU_LIST ML
			ORDER BY PATH
		]]>
	</select>
	
	<!-- ====================================================================================== -->
	<!--									메뉴코드 등록											-->
	<!-- ====================================================================================== -->
	<select id="MenuSQL.doGetMaxMenuAuthSeq" resultType="int">
		<!-- 2020-05-09 추정완 -->
		/*
			SQL ID : MenuSQL.doGetMaxMenuAuthSeq
			메뉴권한 시퀀스 최댓값 가져오기
		*/
		<![CDATA[
			SELECT
				MAX(MENUAUTH_SEQ) + 1
			FROM
				TA_MENU_AUTH
		]]>
	</select>
	
	<select id="MenuSQL.doListAuth" resultType="dataMap">
		<!-- 2020-05-09 추정완 -->
		/*
			SQL ID : MenuSQL.doListAuth
			권한 종류 리스트 가져오기
		*/
		<![CDATA[
			SELECT 
				COMMCD 
			FROM 
				TA_COMM_CODE 
			WHERE
				SITEID = #{siteid}
			AND	COMMCD_GCD = 'ROLE_PCD' 
			AND COMMCD_LVL = 2
		]]>
	</select>
	
	<insert id="MenuSQL.doInsertMainMenu" parameterType="dataMap">
		<!-- 2020-05-07 추정완 -->
		/*
			SQL ID : MenuSQL.doInsertMainMenu
			대메뉴 등록
		*/

			<![CDATA[
			INSERT INTO 
				TA_MENU
				(
					MENUCD,
					UP_CD,
					MENUNM,
					MENUNM_EN,
					MENU_LVL,
					MENU_IDX,
					MENU_CMMT,
					MENU_URL,
					REF_SITEID,
					MENU_PCD,
					MENU_TCD,
					MENU_OPT,
					MENU_STAT,
					REGUID,
					MODUID,
					REGDTM,
					MODDTM,
					USEYN,
					SITEID
				)
				VALUES
				(
					TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'),
					#{up_cd},
					#{menunm},
					#{menunm_en},
					1,
					1,
					#{menu_cmmt},
					#{menu_url},
					#{siteid},
					#{menu_pcd},
					#{menu_tcd},
					0,
					0,
					#{userid},
					#{userid},
					TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'),
					TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'),
					#{useyn},
					#{siteid}
				)
			]]>
	</insert>
	
	<insert id="MenuSQL.doInsertMainMenuAuth" parameterType="dataMap" useGeneratedKeys="false">
		<!-- 2020-05-09 추정완 -->
		/*
			SQL ID : MenuSQL.doInsertMainMenuAuth
			대메뉴 등록시 모든 권한의 데이터에 같이 추가
		*/
		<foreach collection="list" item="item" index="index" separator=";" close=";">
			INSERT INTO TA_MENU_AUTH
			(
				MENUAUTH_SEQ
				, MENUCD
				, ROLE_PCD
				, USEAUTH
				, NOTE
				, REGUID
				, MODUID
				, REGDTM
				, MODDTM
				, USEYN
				, SITEID
			)
			VALUES
			(
				#{item.menuauth_seq}
				, TO_CHAR(NOW(), 'YYYYMMDDHH24MISS')
				, #{item.role_pcd}
				, 0
				, 'jstree-unchecked'
				, #{userid}
				, #{userid}
				, TO_CHAR(NOW(), 'YYYYMMDDHH24MISS')
				, TO_CHAR(NOW(), 'YYYYMMDDHH24MISS')
				, 'N'
				, #{siteid}
			)
		</foreach>
	</insert>
	
	<insert id="MenuSQL.doInsertSubMenu" parameterType="dataMap">
		<!-- 2020-05-07 추정완 -->
		/*
			SQL ID : MenuSQL.doInsertSubMenu
			서브메뉴 등록
		*/
			<![CDATA[
			INSERT INTO 
				TA_MENU
				(
					MENUCD,
					UP_CD,
					MENUNM,
					MENUNM_EN,
					MENU_LVL,
					MENU_IDX,
					MENU_CMMT,
					MENU_URL,
					REF_SITEID,
					MENU_PCD,
					MENU_TCD,
					MENU_OPT,
					MENU_STAT,
					REGUID,
					MODUID,
					REGDTM,
					MODDTM,
					USEYN,
					SITEID
				)
				VALUES
				(
					TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'),
					#{up_cd},
					#{menunm},
					#{menunm_en},
					#{menu_lvl}::INT,
					(SELECT COALESCE(MAX(MENU_IDX), 0) + 1 FROM TA_MENU WHERE UP_CD = #{up_cd}),
					#{menu_cmmt},
					#{menu_url},
					#{siteid},
					#{menu_pcd},
					#{menu_tcd},
					0,
					0,
					#{userid},
					#{userid},
					TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'),
					TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'),
					#{useyn},
					#{siteid}
				)
			]]>
	</insert>
		<insert id="MenuSQL.doInsertSubMenuAuth" parameterType="dataMap" useGeneratedKeys="false">
		<!-- 2020-05-09 추정완 -->
		/*
			SQL ID : MenuSQL.doInsertMainMenuAuth
			서브메뉴 등록시 모든 권한의 데이터에 같이 추가
		*/
		<foreach collection="list" item="item" index="index" separator=";" close=";">
			INSERT INTO TA_MENU_AUTH
			(
				MENUAUTH_SEQ
				, MENUCD
				, ROLE_PCD
				, USEAUTH
				, NOTE
				, REGUID
				, MODUID
				, REGDTM
				, MODDTM
				, USEYN
				, SITEID
			)
			VALUES
			(
				#{item.menuauth_seq}::INT
				, TO_CHAR(NOW(), 'YYYYMMDDHH24MISS')
				, #{item.role_pcd}
				, 0
				, 'jstree-unchecked'
				, #{userid}
				, #{userid}
				, TO_CHAR(NOW(), 'YYYYMMDDHH24MISS')
				, TO_CHAR(NOW(), 'YYYYMMDDHH24MISS')
				, 'N'
				, #{siteid}
			)
		</foreach>
	</insert>
	
	<!-- ====================================================================================== -->
	<!--									메뉴코드 수정											-->
	<!-- ====================================================================================== -->
	<select id="MenuSQL.doGetMenuInfo" resultType="dataMap">
		<!-- 2020-05-08 추정완 -->
		/*
			SQL ID : MenuSQL.doGetMenuInfo
			메뉴 정보가져오기
		*/
		<![CDATA[
			SELECT
				*
			FROM
				TA_MENU
			WHERE
				SITEID = #{siteid}
			AND MENUCD = #{menucd}
		]]>
	</select>	
	<update id="MenuSQL.doUpdateMenu" parameterType="dataMap">
		<!-- 2020-05-08 추정완 -->
		/*
			SQL ID : MenuSQL.doUpdateMenu
			메뉴 수정하기
		*/
		<![CDATA[
			UPDATE
				TA_MENU
			SET
				MENUNM = #{menunm},
				MENUNM_EN = #{menunm_en},
				MENU_CMMT = #{menu_cmmt},
				MENU_PCD = #{menu_pcd},
				MENU_URL = #{menu_url},
				MODUID = #{userid},
				MODDTM = TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'),
				USEYN = #{useyn}
			WHERE
				SITEID = #{siteid}
			AND MENUCD = #{menucd}
		]]>
	</update>
	
	<update id="MenuSQL.doUpdateChildMenu" parameterType="dataMap">
		<!-- 2020-05-08 추정완 -->
		/*
			SQL ID : MenuSQL.doUpdateChildMenu
			자식 메뉴들 사용여부 일괄 수정
		*/
		<![CDATA[
			UPDATE
				TA_MENU
			SET
				MODUID = #{userid},
				MODDTM = TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'),
				USEYN = #{useyn}
			WHERE
				SITEID = #{siteid}
			AND MENUCD IN
		]]>	
		<foreach collection="list" item="item" index="index" open="(" separator="," close=")">
			#{item.menucd}
		</foreach>
	</update>
	
	<!-- ====================================================================================== -->
	<!--									메뉴코드 삭제											-->
	<!-- ====================================================================================== -->
	<delete id="MenuSQL.doDeleteMenu" parameterType="dataMap">
		<!-- 2020-05-08 추정완 -->
		/*
			SQL ID : MenuSQL.doDeleteMenu
			메뉴 삭제
		*/
		<![CDATA[
			DELETE
			FROM
				TA_MENU
			WHERE
				SITEID = #{siteid}
			AND MENUCD IN
		]]>
		<foreach collection="cdlist" item="item" index="index" open="(" separator="," close=")">
				#{item.menucd}
		</foreach>
	</delete>
	<delete id="MenuSQL.doDeletemenuAuth" parameterType="dataMap">
		<!-- 2020-05-09 추정완 -->
		/*
			SQL ID : MenuSQL.doDeletemenuAuth
			메뉴 삭제시 권한메뉴 테이블의 메뉴 일괄 삭제
		*/
		<![CDATA[
			DELETE
			FROM
				TA_MENU_AUTH
			WHERE
				SITEID = #{siteid}
		]]>
			AND MENUCD IN 
		<foreach collection="cdlist" item="item" index="index" open="(" separator="," close=")">
			#{item.menucd}
		</foreach>
			AND ROLE_PCD IN
		<foreach collection="list" item="item" index="index" open="(" separator="," close=")">
			#{item.role_pcd}
		</foreach>
	</delete>
	
	<update id="MenuSQL.doUpdateMenuState" parameterType="dataMap">
		<!-- 2020-06-03 최상규 -->
		/*
			SQL ID : MenuSQL.doUpdateMenuState
			메인메뉴에 서브메뉴가 추가된 상태로 변경
		*/		
			UPDATE TA_MENU_AUTH
			SET 
				NOTE = 'jstree-undetermined'
			WHERE 
				MENUCD = #{up_cd}
			AND USEYN = 'Y'
			AND SITEID = #{siteid}					
	</update>
	
	<update id="MenuSQL.doUpdateMenuLevel" parameterType="dataMap">
		<!-- 2020-06-03 최상규 -->
		/*
			SQL ID : MenuSQL.doUpdateMenuLevel
			메뉴 레벨변경(이동)
		*/
		<![CDATA[
			UPDATE TA_MENU
			SET
				UP_CD = #{up_cd},
				MENU_LVL = #{menu_lvl}::INT
			WHERE
				 MENUCD = #{menucd}				
			AND  SITEID = #{siteid}
		]]>	
	</update>
	
	<update id="MenuSQL.doUpdateChildMenuLevel" parameterType="dataMap">
		<!-- 2020-06-03 최상규 -->
		/*
			SQL ID : MenuSQL.doUpdateChildMenuLevel
			자식 메뉴 레벨변경(이동)
		*/		
			UPDATE TA_MENU
			SET 
				MENU_LVL = #{cmenu_lvl},
				MODUID = #{userid},
				MODDTM  = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
			WHERE 
				UP_CD = #{menucd}
			AND SITEID = #{siteid}					
	</update>
	
	<update id="MenuSQL.doUpdateMenuIdx" parameterType="dataMap">
		<!-- 2020-06-03 최상규 -->
		/*
			SQL ID : MenuSQL.doUpdateMenuIdx
			메뉴 순서변경
		*/		
		<foreach  item="list" collection="list"  index="index" separator=";" close=";" >
			<![CDATA[
				UPDATE TA_MENU
				SET 
					MENU_IDX = #{list.menu_idx},
					MODUID = #{userid},
					MODDTM  = TO_CHAR(NOW(), 'YYYYMMDDHH24MISS')
				WHERE 
					MENUCD = #{list.menucd}
				AND SITEID = #{siteid}		
			]]>		
		</foreach>
	</update>
	
</mapper>