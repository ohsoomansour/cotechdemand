<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="FileSQL">

	<select id="FileSQL.getFileList" resultType="dataMap">
		/*
			SQL ID : FileSQL.getFileList
			파일 리스트
		*/
		<![CDATA[
			SELECT A.fmst_path, A.fmst_topic, B.*
			FROM TB_FILE_MST AS A 
				LEFT JOIN TB_FILE_SLV AS B ON A.fmst_seq = B.fmst_seq
			WHERE A.fmst_seq = #{fmst_seq}::INT
			 AND B.useyn = 'Y'
		]]>
	</select>
	
	<select id="FileSQL.getFile" resultType="dataMap">
		/*
			SQL ID : FileSQL.getFileList
			파일 리스트
		*/
		<![CDATA[
			SELECT A.fmst_path, A.fmst_topic, B.*
			FROM TB_FILE_MST AS A 
				LEFT JOIN TB_FILE_SLV AS B ON A.fmst_seq = B.fmst_seq
			WHERE A.fmst_seq = #{fmst_seq}::INT
			 AND B.fslv_seq = #{fslv_seq}::INT
			 AND B.useyn = 'Y'
		]]>
	</select>
	<select id="FileSQL.getFileSlv" resultType="dataMap">
		/*
			SQL ID : FileSQL.getFileSlv
			파일 리스트
		*/
		<![CDATA[
			SELECT A.fmst_path, A.fmst_topic, B.*,
			coalesce ((select dt.doc_name 
			from tbldocdtl dt
			where dt.doc_code = B.f_type),'기타') as doc_name
			FROM TB_FILE_MST AS A 
				LEFT JOIN TB_FILE_SLV AS B ON A.fmst_seq = B.fmst_seq
			WHERE A.fmst_seq = #{fmst_seq}::INT
			 AND B.useyn = 'Y'
		]]>
	</select>

	<insert id="FileSQL.createFmst" parameterType="dataMap" useGeneratedKeys="true" keyProperty="fmst_seq">
		/*
			SQL ID : FileSQL.createFmst
			파일 마스터 생성
		*/
		<![CDATA[
		INSERT INTO TB_FILE_MST
			( 
				fmst_path,
				fmst_topic
			)
		VALUES
			( 
				#{fmst_path},
				#{fmst_topic}
			)
		]]>
	</insert>
	
	<insert id="FileSQL.createFsvl" parameterType="dataMap" useGeneratedKeys="false">
		/*
			SQL ID : FileSQL.createFsvl
			파일 슬레이브 생성
		*/
		<![CDATA[
		INSERT INTO TB_FILE_SLV
			(
				fmst_seq,
				f_org_nm,
				f_srv_nm,
				f_ext,
				f_size,
				f_type,
				f_cont_type,
				reguid,
				moduid,
				regdtm,
				moddtm,
				siteid,
				useyn,
				checkyn
			)
		VALUES
			( 
				#{fmst_seq},
				#{f_org_nm},
				#{f_srv_nm},
				#{f_ext},
				#{f_size},
				#{f_type},
				#{f_cont_type},
				#{userid},
				#{userid},
				TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'),
				TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'),
				#{siteid},
				#{useyn},
				'N'
			)
		]]>
	</insert>

	<update id="FileSQL.modifyFile" parameterType="dataMap">
	<![CDATA[
		UPDATE TB_FILE_SLV
		SET 
			f_type = #{f_type}, 
			moddtm = TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'),
			moduid = #{userid} 
		WHERE fmst_seq = #{fmst_seq}::INT
			AND fslv_seq = ${fslv_seq}::INT
	]]>
	</update>
	
	<update id="FileSQL.deleteFile" parameterType="dataMap">
	<![CDATA[
		UPDATE TB_FILE_SLV
		SET 
			useyn = 'N', 
			moddtm = TO_CHAR(NOW(), 'YYYYMMDDHH24MISS'),
			moduid = #{userid} 
		WHERE fmst_seq = #{fmst_seq}::INT
			AND fslv_seq = ${fslv_seq}::INT
	]]>
	</update>
	<select id="FileSQL.getFileCode" resultType="dataMap">
		/*
			SQL ID : FileSQL.getFileCode
			파일 코드값 가져오기
		*/
			select 
			t.subject_proc_name as text,
			t.subject_proc_code ,
			td.doc_name ,
			td.doc_code as value,
			td.doc_order 
			from tbldoc t 
			inner join tbldocdtl td on t.subject_proc_code = td.subject_proc_code 
			where t.subject_proc_code  = '${subject_proc_code}'
			and td.doc_type = 'F'
			and t.delete_flag = 'N'
			and t.use_flag = 'Y'
			order by td.doc_order ;
	</select>
</mapper>