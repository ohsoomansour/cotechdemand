<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="CommonfnFrontSQL">

	<select id="CommonfnFrontSQL.countAccountBook" resultType="int" parameterType="dataMap">
		/*
		2021.08.06 박성민
		SQL ID : CommonfnFrontSQL.countAccountBook
		가계부 카운트
				*/
		SELECT
		count(*)
		FROM
		tblsubject ts
		inner join tblsubject_settle tss on ts.subject_seqno = tss.subject_seqno and tss.settle_type = 'A10'
		inner join tblsubject_settle_detail tsd on ts.subject_seqno = tsd.subject_seqno and tsd.settle_type = 'A10' and tsd.settle_seqno = '1'
		inner join tblproject tp on ts.project_seqno = tp.project_seqno
		inner join tblsubject_member tmsc on ts.subject_seqno = tmsc.subject_seqno  and tmsc.member_role ='SC'
		inner join tblsubject_member tmdc on ts.subject_seqno = tmdc.subject_seqno  and tmdc.member_role ='DC'
		where ts.delete_flag ='N'
		and tmsc.member_seqno = #{insert_user}::INT
		<if test="check_edate != ''" >
		and tsac.check_date between #{check_sdate}::INT and  #{check_edate}::INT  
		</if>    
		<if test="project_title != ''" >
		AND 
		tp.project_title like CONCAT('%',#{project_title},'%')
		</if>
		<if test="subject_ref != ''" >
		AND 
		ts.subject_ref like CONCAT('%',#{subject_ref},'%')
		</if>
		<if test="subject_title != ''" >
		AND 
		ts.subject_title like CONCAT('%',#{subject_title},'%')
		</if>
		<if test="sc_biz_name != ''" >
		AND 
		tmsc.biz_name like CONCAT('%',#{sc_biz_name},'%')
		</if>
		<if test="dc_biz_name != ''" >
		AND 
		tmdc.biz_name like CONCAT('%',#{dc_biz_name},'%')
		</if> 
	</select>
	<select id="CommonfnFrontSQL.selectAccountBookList" resultType="dataMap" parameterType="dataMap">
		/*
		2021.08.06 박성민
		SQL ID : CommonfnFrontSQL.selectAccountBookList
		가계부_리스트
		*/
		select 
		ts.project_seqno,
		ts.subject_seqno,
		ts.subject_title,
		tc.total_cost ,
		tc.gov_cost ,
		tc.com_cost ,
		tc.vat_cost ,
		substring(cast(ts.subject_sdate as text),3,9) as subject_sdate,
		substring(cast(ts.subject_edate as text),3,9) as subject_edate,
		ts.subject_ref,
		ts.sector_lev1 ,
		ts.sector_lev2 ,
		tmsc.biz_name as tmsc_biz_name,
		tmdc.biz_name as tmdc_biz_name,
		ts.subject_proc_status  as ts_subject_proc_status,
		tsd.use_rate as use_rate
		from tblsubject ts 
		inner join tblproject tp on ts.project_seqno = tp.project_seqno
		inner join tblsubject_contract tc on ts.subject_seqno = tc.subject_seqno 
		inner join tblsubject_settle tss on ts.subject_seqno = tss.subject_seqno and tss.settle_type = 'A10'
		inner join tblsubject_settle_detail tsd on ts.subject_seqno = tsd.subject_seqno and tsd.settle_type = 'A10' and tsd.settle_seqno = '1'
		inner join tblsubject_member tmsc on ts.subject_seqno = tmsc.subject_seqno  and tmsc.member_role ='SC'
		inner join tblsubject_member tmdc on ts.subject_seqno = tmdc.subject_seqno  and tmdc.member_role ='DC'
		where
		tp.project_title like CONCAT('%',#{project_title},'%')
		and tmsc.member_seqno = #{insert_user}::INT   
		<if test="subject_ref != ''" >
		AND 
		ts.subject_ref like CONCAT('%',#{subject_ref},'%')
		</if>
		<if test="subject_title != ''" >
		AND 
		ts.subject_title like CONCAT('%',#{subject_title},'%')
		</if>
		<if test="sc_biz_name != ''" >
		AND 
		tmsc.biz_name like CONCAT('%',#{sc_biz_name},'%')
		</if>
		<if test="dc_biz_name != ''" >
		AND 
		tmdc.biz_name like CONCAT('%',#{dc_biz_name},'%')
		</if> 
	</select>
	<select id="CommonfnFrontSQL.selectAccountBookDetail" resultType="dataMap" parameterType="dataMap">
		/*
		2021.07.01 박성민
		SQL ID : SubjectSQL.selectAddCheckDetail
		가계부 디테일 조회
		*/
		SELECT
		*
		FROM
		tblsubject_settle_detail tsd
		where 
		tsd.subject_seqno = #{subject_seqno}::INT
		and
		tsd.settle_type = 'A10'
	</select>
	<select id="CommonfnFrontSQL.selectAccountBookSumCost" resultType="int" parameterType="dataMap">
		/*
		2021.08.06 박성민
		SQL ID : CommonfnFrontSQL.selectAccountBookSumCost
		가계부 집행금액
				*/
		SELECT
		sum(tsd.cost)
		FROM
		tblsubject_settle_detail tsd
		where 
		tsd.subject_seqno = #{subject_seqno}::INT
		and
		tsd.settle_type = 'A10'
	</select>
	
	<select id="CommonfnFrontSQL.selectAccountBookHist" resultType="dataMap" parameterType="dataMap">
		/*
		2021.08.06 박성민
		SQL ID : CommonfnFrontSQL.selectAccountBookHist
		가계부 히스토리 상세 조회
		*/
		select 
		tsd.settle_seqno,
		tsd.subject_seqno,
		tsh.seqno,
		tsh.item,
		tsh.cost,
		tsh.subject_proc_date,
		tsh.purpose,
		tsd.use_cost,
		tsd.use_rate
		from tblsubject_settle_detail tsd 
		left outer join tblsubject_settle_hist tsh on tsd.subject_seqno = tsh.subject_seqno and tsd.settle_seqno = tsh.settle_seqno 
		where tsd.settle_type ='A10'
		and tsd.subject_seqno  = ${subject_seqno}::INT
		and tsd.settle_seqno = '${settle_seqno}' 
	</select>
	<insert id="CommonfnFrontSQL.insertSettleHist" parameterType="dataMap">
		/*
		2021.08.07 박성민
		SQL ID :
		CommonfnFrontSQL.insertSettleHist
		가계부 내역 생성
		*/
		INSERT INTO
		tblsubject_settle_hist
		(
		subject_seqno,
		settle_seqno,
		seqno,
		item,
		purpose,
		cost,
		subject_proc_date,
		insert_user,
		insert_ip,
		insert_date,
		delete_flag
		)
		VALUES
		(
		#{subject_seqno}::INT,
		#{settle_seqno}::INT,
		#{seqno}::INT,
		#{item},
		#{purpose},
		#{cost}::INT,
		CAST(#{subject_proc_date} as timeStamp),
		#{insert_user}::INT,
		#{insert_ip},
		CAST(NOW() AS timeStamp),
		'N'
		)
	</insert>
	<update id="CommonfnFrontSQL.updateSettleHist" parameterType="dataMap">
		/*
		2021.08.07 박성민
		SQL ID : CommonfnFrontSQL.updateSettleHist
		가계부 내역 수정
		*/
		UPDATE tblsubject_settle_hist
		SET
		item = #{item},
		purpose = #{purpose},
		cost = #{cost}::INT,
		update_user = #{insert_user}::INT,
		update_ip = #{insert_ip},
		update_date = CAST(NOW() AS timeStamp)
		WHERE
		subject_seqno = #{subject_seqno}::INT
		and
		settle_seqno = #{settle_seqno}::INT
		and
		seqno = #{seqno}::INT
	</update>
	<select id="CommonfnFrontSQL.maxHistSeqno" resultType="int" parameterType="dataMap">
		/*
		2021.08.06 박성민
		SQL ID : CommonfnFrontSQL.maxHistSeqno
		가계부 seqno가져오기
				*/
		select coalesce(max(seqno),0)
		from tblsubject_settle_hist tsh 
		where 
		subject_seqno = #{subject_seqno}::INT
		and 
		settle_seqno = #{settle_seqno}::INT
	</select>
	<update id="CommonfnFrontSQL.updateSettleDetail" parameterType="dataMap">
		/*
		2021.08.07 박성민
		SQL ID : CommonfnFrontSQL.updateSettleDetail
		가계부 내역 수정
		*/
		UPDATE tblsubject_settle_detail
		SET
		use_cost = #{use_cost}::INT,
		use_rate = #{use_rate}
		WHERE
		subject_seqno = #{subject_seqno}::INT
		and
		settle_seqno = #{settle_seqno}::INT
		and
		settle_type = #{settle_type}
	</update>
	
	<select id="CommonfnFrontSQL.selectSettleDetail" resultType="dataMap" parameterType="dataMap">
		/*
		2021.08.07 박성민
		SQL ID : SubjectSQL.selectAddCheckDetail
		가계부 디테일 조회
		*/
		select *
		from tblsubject_settle_detail
		where
		subject_seqno = #{subject_seqno}::INT
		and
		settle_type = 'A10'
		and
		settle_seqno = #{settle_seqno}::INT
	</select>
</mapper>	